<!DOCTYPE html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><link href=http://gmpg.org/xfn/11 rel=profile><meta http-equiv=content-type content="text/html; charset=utf-8"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Continuous Deployment of Ghost from Github &middot; Maksim.IO | MrMaksimize</title><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=/assets/stylesheets/style.min.72db41b6.css><link rel=stylesheet href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400"><script src=/assets/javascript/all.min.74be1697.js></script><link rel=apple-touch-icon-precomposed sizes=144x144 href=/assets/images/touch/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/assets/favicon.ico><link rel=alternate type=application/rss+xml title=RSS href=/atom.xml></head><body class=sidebar-overlay><input type=checkbox class=sidebar-checkbox id=sidebar-checkbox><div class=sidebar id=sidebar><div class=sidebar-item><img class=sidebar-image width=100% height=100% src="/assets/maksim.jpg"><p>Gov, Code, Thoughts. This is a place for me to speak freely and represent no one.</p></div><nav class=sidebar-nav><a class=sidebar-nav-item href="/">Home</a> <a class=sidebar-nav-item href=/about.html>About</a> <span class="sidebar-nav-item social-links"><a href=https://github.com/mrmaksimize target=_blank title=Github><i class="fa fa-2x fa-github"></i></a> <a href=https://twitter.com/mrmaksimize target=_blank title=Twitter><i class="fa fa-2x fa-twitter"></i></a> <a href=https://linkedin.com/in/maxpecherskiy target=_blank title=LinkedIN><i class="fa fa-2x fa-linkedin"></i></a> <a href=mailto:max@maksimize.com><i class="fa fa-2x fa-envelope-o" title=E-Mail></i></a> <a href=/atom.xml title=RSS target=_blank><i class="fa fa-2x fa-rss"></i></a></span></nav><div class=sidebar-item><p>&copy; 2015. All rights reserved.</p></div></div><div class=wrap><div class=masthead><div class=container><h3 class=masthead-title><a href="/" title=Home>Maksim.IO | MrMaksimize</a></h3></div></div><div class="container content"><div class=post><h1 class=post-title>Continuous Deployment of Ghost from Github</h1><span class=post-date>08 Feb 2014</span><p>As part of my fellowship at <a href=http://codeforamerica.org>Code For America</a>, my team had to set up a blog in order to keep everyone updated about what we&rsquo;re doing and how everything is going. Most teams just set up a tumblr blog. However I had some ethical qualms about doing that and successfully was able to convince my team to agree to running <a href=http://tryghost.org>Ghost</a>.</p><p>Ghost is a very interesting blogging platform. It came about as an answer to the bloat of WordPress into a massive CMS which is pretty resource intensive. It&rsquo;s written entirely in Node with SQLite3 database backend. Additionally, it provides for a very nice interface in editing posts using Markdown and basically does everything you need a simple publishing platform to do for you.</p><p>After I set it up, my team&rsquo;s designer, Ainsley wanted to make some CSS changes to the blog and the theme. She would make the changes, push them up to GitHub, but the problem was she was waiting for me to jump onto the server and pull the changes in. On top of that, every time the codebase needs an update, the Ghost service on the machine needs to be restarted.</p><p>This now meant I was a bottleneck to any development being done on the blog. I didn&rsquo;t like it.</p><p>I started researching into how to automate this process, and found a few articles. Namely these two helped out:</p><ul><li><a href=http://fideloper.com/node-github-autodeploy>Fideloper</a></li><li><a href="http://gun.io/blog/tutorial-deploy-node-js-server-with-example/">Gun.io</a></li></ul><p>I would definitely recommend reading them. However, my use case wasn&rsquo;t as complex as these articles describe. However, they did point me a to pretty sweet node package called <a href=https://github.com/coreh/hookshot>HookShot</a>. It&rsquo;s an extremely simple tool that allows you to listen for incoming GitHub post-receive hooks and react accordingly. You can use it as a library, a CLI tool, or even mount it on top of your existing Express servers.</p><p>So, here are the steps</p><p><strong>I am making assumptions here such as you&rsquo;re running Ubuntu and have Upstart</strong></p><h3>Make an upstart steps for running you ghost service.</h3><p>Make a file in <code>/etc/init/ghost-YOUR_SITE_NAME.conf</code> Add the following:</p><div class=highlight><pre><code class=language-bash data-lang=bash># ghost-YOUR_SITE_NAME

start on startup

script
    cd /path/to/your/ghost/root
    npm start --production
end script</code></pre></div><p>This will let you run the ghost process as a service.</p><h3>Write the listener script</h3><p>Pick a port where you know nothing is running. If you look at Ghost&rsquo;s config.js file, you will see what port the ghost service is started. You can always run <code>netstat --listen</code> and see if the port number you chose is being used by a service.</p><p>Create a file and add it to the code base at the root of ghost; I called it <code>deploy_listener.js</code>, but really the name doesn&rsquo;t matter. I&rsquo;m considering renaming it to something that has to do with monkeys, because I like monkeys. The contents of the file are pretty simple:</p><div class=highlight><pre><code class=language-js data-lang=js>var hookshot = require(&#39;hookshot&#39;);
hookshot(&#39;refs/heads/master&#39;, &#39;git fetch origin &amp;&amp; git checkout origin/master &amp;&amp; service ghost-coqui restart&#39;).listen(PORT_NUMBER)</code></pre></div><p><strong><em>Don&rsquo;t forget to replace the port number</em></strong></p><p>Now we&rsquo;re going to have a process listening, but putting nginx in front of this process as well didn&rsquo;t seem to make a lot of sense to me. The nginx would have to listen to either a subdomain or another port, and the next step would be necessary either way. So I decided to bypass messing with nginx and opened up the firewall directly to the node server:</p><h3>Opening up the firewall for the listener</h3><p>Now, we need to open the IPTABLES firewall to allow requests to the port that hookshot will be running on. This command should do it for us:</p><div class=highlight><pre><code class=language-bash data-lang=bash># Need to be a priviledged user
$ sudo iptables -I INPUT 4 -p tcp --dport 9001 -j ACCEPT # (I)nserts this rule after the 4th iptables firewall rule</code></pre></div><h3>Starting and running the hookshot process</h3><p>Last part but not least, we need to start the hookshot process to listen for webhooks from GitHub.</p><p>I just took the much easier way and installed forever to run the listener, but I&rsquo;m pretty sure you can just set it up as another upstart process. In fact, you probably should since that would allow it to start running whenever your server gets rebooted. If you want to do that:</p><p>Make a file in <code>/etc/init/ghost-YOUR_SITE_NAME-listener.conf</code> Add the following:</p><div class=highlight><pre><code class=language-bash data-lang=bash># ghost-YOUR_SITE_NAME-listener

start on startup

script
    cd /path/to/your/ghost/root
    node deploy_listener.js
end script</code></pre></div><p>The other option is use forever to run the process.</p><div class=highlight><pre><code class=language-bash data-lang=bash>npm install -g forever
forever start /path/to/your/ghost/deploy_listener.js</code></pre></div><h3>Getting github&rsquo;s webhook set up</h3><ul><li>Go To Settings on your GitHub repo: <img src=https://monosnap.com/image/wLflXqInHVFsMsMBMMsaZoelSSeHVr.png alt="Github Settings"></li><li>In the left menu, select Service Hooks.</li><li>Under services click on Webhook URLs and add the url of your path with the port number after it. For example for our blog it&rsquo;s <code>coquicoders.org:9732</code></li><li>After you save, you should have a button to test the hook <img src=https://monosnap.com/image/uNqdDjBeq4jwFVedg9Chk3Dw211UGf.png alt=Screenshot></li><li>Test the hook and make sure it works. It might help for testing if you just run <code>node deploy_helper.js</code> before you start it up as a forever or upstart process, just so you can see it working.</li></ul><h3>Things to look into</h3><p>You know how I said this is quick and dirty. I meant it. If you have suggestions or notes, please do let me know. Here are the things I know I need to look into:</p><ul><li>Should I put nginx in front of the hookshot listener?</li><li>Permissions for restarting the ghost service?</li><li>I don&rsquo;t think I need to use forever since I can just run the hookshot listener as a service.</li><li>It may make sense to just inject hookshot directly into ghost to avoid opening up yet another port.</li><li>Hardening the whole thing</li></ul></div><div class=related><h2>Related Posts</h2><ul class=related-posts><li><h3><a href="/webhooks/">Webhooks: A Different Pattern <small>03 Sep 2014</small></a></h3></li><li><h3><a href="/the-zen-of-code/">The Zen Of Code <small>23 Oct 2012</small></a></h3></li><li><h3><a href="/firm_grip_menus_drupal/">Firm Grip on Menus in Drupal <small>05 Jun 2013</small></a></h3></li></ul></div></div></div><label for=sidebar-checkbox class=sidebar-toggle></label></body></html>